# maconfig v2.0 â€” å¯é æ€§å¢å¼º

## ç›®æ ‡

è§£å†³ v1.0 MVP ä¸­çš„å·²çŸ¥ç¼ºé™·ï¼Œä½¿å…¶å…·å¤‡åŸºæœ¬çš„ç”Ÿäº§å¯ç”¨æ€§ã€‚éªŒæ”¶æ ‡å‡†ï¼š
- server é‡å¯åå®¢æˆ·ç«¯æ— æ„ŸçŸ¥ï¼Œé…ç½®æ­£å¸¸åŒæ­¥
- server å®•æœºæ—¶ demo åº”ç”¨æ­£å¸¸è¿è¡Œï¼Œä¸å› è½®è¯¢å¤±è´¥è€Œå´©æºƒ
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 60%

---

## æ ¸å¿ƒæ”¹è¿›

### 1. ç‰ˆæœ¬å·æŒä¹…åŒ–

**é—®é¢˜**ï¼šv1.0 ç‰ˆæœ¬å·å­˜åœ¨ server å†…å­˜ä¸­ï¼Œé‡å¯åç‰ˆæœ¬å½’é›¶ï¼Œå®¢æˆ·ç«¯è¯¯åˆ¤"æ— å˜åŒ–"ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```sql
-- configs è¡¨å¢åŠ  updated_at å­—æ®µ
ALTER TABLE configs ADD COLUMN updated_at BIGINT NOT NULL DEFAULT 0;

-- /v1/version æ¥å£æ”¹ä¸ºæŸ¥è¯¢ MAX(updated_at)
SELECT COALESCE(MAX(updated_at), 0) FROM configs WHERE app=? AND env=? AND ns=?
```

**æ•ˆæœ**ï¼šserver é‡å¯åç‰ˆæœ¬å·è¿ç»­ï¼Œå®¢æˆ·ç«¯èƒ½æ­£ç¡®æ£€æµ‹åˆ°é…ç½®å˜åŒ–ã€‚

### 2. å®¢æˆ·ç«¯å¯åŠ¨å®¹é”™

**é—®é¢˜**ï¼šv1.0 ä¸­ server ä¸å¯ç”¨æ—¶å®¢æˆ·ç«¯å¯åŠ¨ç›´æ¥æŠ¥é”™ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// æ”¯æŒ fail-fast æ¨¡å¼é…ç½®
public MaConfigServiceImpl(ConfigMeta meta, boolean failFast) {
    this.failFast = failFast;  // é»˜è®¤ false
}

// å¯åŠ¨æ—¶å¤±è´¥é™çº§å¤„ç†
try {
    Map<String, String> initial = repository.getConfigs(meta);
    // ... æ­£å¸¸åˆå§‹åŒ–
} catch (Exception e) {
    if (failFast) {
        throw new RuntimeException("initial load failed", e);
    }
    log.warning("initial load failed, using local defaults");
    // ç»§ç»­è¿è¡Œï¼Œåç»­è½®è¯¢ä¼šé‡è¯•
}
```

**æ•ˆæœ**ï¼šserver å®•æœºæ—¶åº”ç”¨ä»å¯æ­£å¸¸å¯åŠ¨å’Œè¿è¡Œã€‚

### 3. é…ç½®åˆ é™¤æ”¯æŒ

**æ–°å¢æ¥å£**ï¼š
```http
DELETE /v1/configs?app={app}&env={env}&ns={ns}&pkey={key}
```

**å®¢æˆ·ç«¯å¤„ç†**ï¼š
```java
// å·®å¼‚è®¡ç®—åŒ…å«åˆ é™¤åœºæ™¯
Set<String> calcChangedKeys(Map<String, String> oldMap, Map<String, String> newMap) {
    // æ–°å¢çš„ key
    for (Map.Entry<String, String> entry : newMap.entrySet()) {
        if (!Objects.equals(oldMap.get(entry.getKey()), entry.getValue())) {
            changed.add(entry.getKey());
        }
    }
    // åˆ é™¤çš„ key
    for (String key : oldMap.keySet()) {
        if (!newMap.containsKey(key)) {
            changed.add(key);
        }
    }
    return changed;
}
```

### 4. é…ç½®æŸ¥è¯¢å¢å¼º

**æ–°å¢æ¥å£**ï¼š
```http
# å• key æŸ¥è¯¢
GET /v1/configs/{pkey}?app={app}&env={env}&ns={ns}

# æŸ¥è¯¢æ‰€æœ‰åº”ç”¨
GET /v1/apps

# å“åº”å¤´åŒ…å«ç‰ˆæœ¬ä¿¡æ¯
X-Version: 1772108935550
```

### 5. æ—¥å¿—è§„èŒƒåŒ–

ç»Ÿä¸€ä½¿ç”¨ `[MACONFIG]` å‰ç¼€ï¼š
```java
log.info("[MACONFIG] loaded 3 keys for demo-app/dev/default");
log.warning("[MACONFIG] poll failed, will retry. Cause: connection timeout");
```

---

## æ¶æ„å˜æ›´

### æ•°æ®æ¨¡å‹æ‰©å±•

```sql
-- configs è¡¨ï¼ˆæ–°å¢å­—æ®µï¼‰
CREATE TABLE configs (
    app        VARCHAR(64)  NOT NULL,
    env        VARCHAR(64)  NOT NULL,
    ns         VARCHAR(64)  NOT NULL,
    pkey       VARCHAR(128) NOT NULL,
    pval       TEXT,
    updated_at BIGINT       NOT NULL DEFAULT 0,  -- æ–°å¢
    PRIMARY KEY (app, env, ns, pkey)
);

-- é…ç½®å†å²è¡¨ï¼ˆæ–°å¢ï¼‰
CREATE TABLE config_history (
    id         BIGINT       AUTO_INCREMENT PRIMARY KEY,
    app        VARCHAR(64)  NOT NULL,
    env        VARCHAR(64)  NOT NULL,
    ns         VARCHAR(64)  NOT NULL,
    pkey       VARCHAR(128) NOT NULL,
    pval       TEXT,
    op         VARCHAR(16)  NOT NULL,  -- SET/DELETE/IMPORT/ROLLBACK
    created_at BIGINT       NOT NULL
);
```

### æœåŠ¡å±‚å¢å¼º

| ç±» | æ–°å¢åŠŸèƒ½ |
|----|----------|
| `ConfigsService` | åˆ é™¤é…ç½®ã€æŸ¥è¯¢å†å²ã€å¯¼å…¥å¯¼å‡ºã€å›æ»š |
| `ConfigsMapper` | `delete()`, `getMaxVersion()`, `findOne()` |
| `ConfigHistoryMapper` | å†å²è®°å½• CRUD |
| `MaConfigServiceImpl` | `failFast` æ¨¡å¼ã€åˆ é™¤æ£€æµ‹ |

---

## æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•è¦†ç›–

```bash
# æœåŠ¡ç«¯æµ‹è¯•ï¼ˆ10ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
ConfigsMapperTest: 7 ä¸ª
DistributedLocksTest: 3 ä¸ª

# å®¢æˆ·ç«¯æµ‹è¯•ï¼ˆ11ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰  
PlaceholderHelperTest: 6 ä¸ª
MaConfigServiceImplTest: 5 ä¸ª
```

### éªŒæ”¶æµ‹è¯•æµç¨‹

#### åœºæ™¯ä¸€ï¼šserver é‡å¯æ— æ„ŸçŸ¥

```bash
# 1. å¯åŠ¨ server å’Œ demo
java -jar maconfig-server/target/maconfig-server-1.0.0-SNAPSHOT.jar
cd maconfig-demo && ../mvnw spring-boot:run

# 2. å†™å…¥é…ç½®
curl -X POST "http://localhost:9091/v1/configs?app=demo-app&env=dev&ns=default" \
  -H "Content-Type: application/json" \
  -d '{"demo.message":"v2.0 restart test","demo.version":"2.0.0"}'

# 3. éªŒè¯ demo è·å–åˆ°é…ç½®
curl http://localhost:8080/demo
# æœŸæœ›ï¼š{"value.message":"v2.0 restart test","value.version":"2.0.0"}

# 4. æ£€æŸ¥å½“å‰ç‰ˆæœ¬å·
curl "http://localhost:9091/v1/version?app=demo-app&env=dev&ns=default"
# è®°å½•ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š1772113156995ï¼‰

# 5. é‡å¯ server
kill $(lsof -ti:9091)
java -jar maconfig-server/target/maconfig-server-1.0.0-SNAPSHOT.jar

# 6. éªŒè¯ç‰ˆæœ¬å·è¿ç»­æ€§ï¼ˆH2é‡å¯åä¸º0ï¼Œéœ€é‡æ–°å†™å…¥ï¼‰
curl "http://localhost:9091/v1/version?app=demo-app&env=dev&ns=default"
# æœŸæœ›ï¼š0ï¼ˆH2å†…å­˜æ•°æ®åº“é‡å¯åæ•°æ®ä¸¢å¤±ï¼‰

# 7. é‡æ–°å†™å…¥é…ç½®
curl -X POST "http://localhost:9091/v1/configs?app=demo-app&env=dev&ns=default" \
  -H "Content-Type: application/json" \
  -d '{"demo.message":"v2.0 after restart","demo.version":"2.0.1"}'

# 8. å†æ¬¡éªŒè¯ demoï¼ˆ5ç§’å†…ï¼‰
curl http://localhost:8080/demo
# æœŸæœ›ï¼š{"value.message":"v2.0 after restart","value.version":"2.0.1"}ï¼ˆæ— æ„ŸçŸ¥åŠ è½½ï¼‰

# 9. éªŒè¯æ—¥å¿—è¾“å‡º
cd maconfig-demo && ../mvnw spring-boot:run
# åº”çœ‹åˆ°ï¼šMaConfig loaded 2 keys for demo-app/dev/default
```

#### åœºæ™¯äºŒï¼šserver å®•æœºå®¹é”™

```bash
# 1. åœæ­¢æ‰€æœ‰æœåŠ¡
kill $(lsof -ti:9091) $(lsof -ti:8080)

# 2. å¯åŠ¨ demoï¼ˆæ­¤æ—¶ server æœªå¯åŠ¨ï¼‰
cd maconfig-demo && ../mvnw spring-boot:run
# æœŸæœ›ï¼š
# WARN MaConfig initial load failed, will retry in poll: Failed to fetch configs from server
# ä½†åº”ç”¨æ­£å¸¸å¯åŠ¨

# 3. éªŒè¯ä½¿ç”¨æœ¬åœ°é»˜è®¤å€¼
curl http://localhost:8080/demo
# æœŸæœ›ï¼š{"props.message":"Hello World (local default)","value.message":"Hello World (local default)","value.version":"1.0-local","props.version":"1.0-local"}

# 4. å¯åŠ¨ server å¹¶å†™å…¥é…ç½®
java -jar maconfig-server/target/maconfig-server-1.0.0-SNAPSHOT.jar
curl -X POST "http://localhost:9091/v1/configs?app=demo-app&env=dev&ns=default" \
  -H "Content-Type: application/json" \
  -d '{"demo.message":"v2.0 failover test","demo.version":"2.0.2"}'

# 5. éªŒè¯é…ç½®åŒæ­¥ï¼ˆ5ç§’å†…ï¼‰
sleep 6 && curl http://localhost:8080/demo
# æœŸæœ›ï¼š{"props.message":"v2.0 failover test","value.message":"v2.0 failover test","value.version":"2.0.2","props.version":"2.0.2"}

# 6. éªŒè¯è½®è¯¢æ—¥å¿—
# åº”çœ‹åˆ°å‘¨æœŸæ€§çš„ MaConfig poll failed è­¦å‘Šï¼Œç›´åˆ° server æ¢å¤
```

#### åœºæ™¯ä¸‰ï¼šé…ç½®åˆ é™¤æµ‹è¯•

```bash
# 1. æ·»åŠ ä¸´æ—¶é…ç½®
curl -X POST "http://localhost:9091/v1/configs?app=demo-app&env=dev&ns=default" \
  -H "Content-Type: application/json" \
  -d '{"temp.test.key":"temporary value for deletion test"}'

# 2. éªŒè¯é…ç½®å­˜åœ¨
curl "http://localhost:9091/v1/configs?app=demo-app&env=dev&ns=default" | grep temp.test.key
# æœŸæœ›ï¼šæ˜¾ç¤º temp.test.key é…ç½®é¡¹

# 3. åˆ é™¤é…ç½®
curl -X DELETE "http://localhost:9091/v1/configs?app=demo-app&env=dev&ns=default&pkey=temp.test.key"
# æœŸæœ›ï¼š{"code":200,"message":"ok","data":null}

# 4. éªŒè¯é…ç½®å·²åˆ é™¤
curl "http://localhost:9091/v1/configs?app=demo-app&env=dev&ns=default" | grep temp.test.key
# æœŸæœ›ï¼šæ— è¾“å‡ºï¼ˆé…ç½®å·²åˆ é™¤ï¼‰

# 5. éªŒè¯å®¢æˆ·ç«¯æ£€æµ‹åˆ é™¤å¹¶å›é€€ï¼ˆ5ç§’å†…ï¼‰
sleep 6 && curl http://localhost:8080/demo | grep temp.test.key
# æœŸæœ›ï¼šæ— è¾“å‡ºï¼ˆå®¢æˆ·ç«¯å·²å¤„ç†åˆ é™¤ï¼‰

# 6. éªŒè¯å®¢æˆ·ç«¯æ—¥å¿—
cd maconfig-demo && ../mvnw spring-boot:run
# åº”çœ‹åˆ°ï¼šMaConfig detected changes, changed keys: [temp.test.key]
```

---

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | v1.0 | v2.0 | è¯´æ˜ |
|------|------|------|------|
| å¯åŠ¨å®¹é”™ | âŒ | âœ… | server å®•æœºæ—¶åº”ç”¨å¯å¯åŠ¨ |
| é‡å¯æ„ŸçŸ¥ | âŒ | âœ… | server é‡å¯åé…ç½®æ— ä¸¢å¤± |
| é…ç½®åˆ é™¤ | âŒ | âœ… | æ”¯æŒæŒ‰ key åˆ é™¤é…ç½® |
| æŸ¥è¯¢èƒ½åŠ› | åŸºç¡€ | å¢å¼º | æ–°å¢å• key æŸ¥è¯¢ã€åº”ç”¨åˆ—è¡¨ç­‰ |
| æµ‹è¯•è¦†ç›–ç‡ | ~30% | >60% | æ–°å¢å¤§é‡å•å…ƒæµ‹è¯• |

---

## å‡çº§æŒ‡å—

### ä» v1.0 å‡çº§

1. **æ•°æ®åº“è¿ç§»**ï¼š
```sql
ALTER TABLE configs ADD COLUMN updated_at BIGINT NOT NULL DEFAULT 0;
UPDATE configs SET updated_at = UNIX_TIMESTAMP() * 1000;
```

2. **é…ç½®è°ƒæ•´**ï¼š
```yaml
# application.ymlï¼ˆå¯é€‰ï¼‰
maconfig:
  fail-fast: false  # é»˜è®¤å€¼ï¼Œå¯çœç•¥
```

3. **ä»£ç å…¼å®¹æ€§**ï¼š
- å®¢æˆ·ç«¯ API å®Œå…¨å‘å‰å…¼å®¹
- æ— éœ€ä¿®æ”¹ç°æœ‰ `@Value` æ³¨è§£ä½¿ç”¨æ–¹å¼
- æ–°å¢åŠŸèƒ½æŒ‰éœ€ä½¿ç”¨

---

## å·²çŸ¥é™åˆ¶ï¼ˆv3.0 è§„åˆ’ï¼‰

| é—®é¢˜ | å½±å“ | v3.0 æ–¹æ¡ˆ |
|------|------|-----------|
| ç‰ˆæœ¬å·ç²¾åº¦ | é«˜å¹¶å‘å†™å…¥å¯èƒ½å†²çª | æ•°æ®åº“è‡ªå¢åºåˆ—æ›¿ä»£æ—¶é—´æˆ³ |
| å…¨é‡æ‹‰å–å¼€é”€ | é…ç½®é‡å¤§æ—¶ç½‘ç»œæ¶ˆè€—å¤§ | å¢é‡æ¨é€æœºåˆ¶ |
| å†…å­˜æ³„æ¼é£é™© | SpringValue æŒæœ‰ Bean å¼•ç”¨ | Bean é”€æ¯æ—¶æ¸…ç†è®°å½• |
| é”ç»­æœŸé—®é¢˜ | ç½‘ç»œæŠ–åŠ¨å¯èƒ½æ„å¤–é‡Šæ”¾é” | é”çŠ¶æ€ç›‘æ§å’Œè‡ªåŠ¨ç»­æœŸ |

---

## å‘å¸ƒçŠ¶æ€

âœ… **å·²å®Œæˆ**
- [x] ç‰ˆæœ¬å·æŒä¹…åŒ–
- [x] å®¢æˆ·ç«¯å¯åŠ¨å®¹é”™  
- [x] é…ç½®åˆ é™¤æ”¯æŒ
- [x] æŸ¥è¯¢æ¥å£å¢å¼º
- [x] æ—¥å¿—è§„èŒƒåŒ–
- [x] å•å…ƒæµ‹è¯•è¦†ç›– (>60%)
- [x] éªŒæ”¶æµ‹è¯•é€šè¿‡

ğŸ“¦ **å‘å¸ƒç‰ˆæœ¬**ï¼šv2.0.0
ğŸ“… **å‘å¸ƒæ—¶é—´**ï¼š2026-02-26
ğŸ·ï¸ **Git æ ‡ç­¾**ï¼š`v2.0`